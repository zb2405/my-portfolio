name: Configure Containers with Ansible

on:
  workflow_dispatch:

jobs:
  ansible:
    runs-on: self-hosted

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate inventory from Terraform output
        run: |
          mkdir -p ansible/inventory
          cat <<'EOF' > ansible/inventory/generated.yml
          all:
            children:
              cloudflared:
                hosts:
                  cloudflared:
                    ansible_host: 192.168.0.11
                    ansible_user: root
              nginx:
                hosts:
                  nginx-web:
                    ansible_host: 192.168.0.10
                    ansible_user: root
              umami:
                hosts:
                  umami-analytics:
                    ansible_host: 192.168.0.12
                    ansible_user: root
          EOF

      - name: Run Ansible Playbook
        run: |
          ansible-playbook -i ansible/inventory/generated.yml ansible/deploy.yml \
          --extra-vars "cloudflared_tunnel_token=${{ secrets.CLOUDFLARED_TUNNEL_TOKEN }}" \
          --extra-vars "umami_db_password=${{ secrets.UMAMI_DB_PASSWORD }}" \
          --extra-vars "umami_app_secret=${{ secrets.UMAMI_APP_SECRET }}" \
          --extra-vars "umami_username=${{ secrets.UMAMI_USERNAME }}" \
          --extra-vars "umami_password=${{ secrets.UMAMI_PASSWORD }}" \
          --extra-vars "umami_website_id=${{ secrets.UMAMI_WEBSITE_ID }}"