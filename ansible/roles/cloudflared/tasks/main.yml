---
- name: Download cloudflared package
  get_url:
    url: https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
    dest: /tmp/cloudflared.deb
    mode: "0644"

- name: Install cloudflared
  apt:
    deb: /tmp/cloudflared.deb

#################################################
# INSTALL TUNNEL SERVICE (TOKEN MODE)
#################################################

# Token-based install automatically creates:
# /etc/cloudflared/config.yml
# systemd service

- name: Install cloudflared tunnel service
  command: cloudflared service install {{ cloudflared_tunnel_token }}
  args:
    creates: /etc/systemd/system/cloudflared.service

- name: Reload systemd daemon
  command: systemctl daemon-reexec

- name: Enable and start cloudflared
  systemd:
    name: cloudflared
    enabled: yes
    state: started

#################################################
# VERIFY TUNNEL IS ACTIVE
#################################################

- name: Check cloudflared service state
  command: systemctl is-active cloudflared
  register: cloudflared_status
  changed_when: false

- name: Fail if tunnel is not running
  fail:
    msg: "Cloudflared tunnel is NOT active"
  when: cloudflared_status.stdout != "active"

- name: Show cloudflared version
  command: cloudflared --version
  register: cf_version
  changed_when: false

- debug:
    var: cf_version.stdout
