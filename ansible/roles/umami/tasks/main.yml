---
- name: Install base packages
  apt:
    name:
      - curl
      - ca-certificates
      - gnupg
      - git
      - rsync
      - nodejs
      - npm
      - postgresql
      - postgresql-contrib
      - python3-psycopg2
    state: present
    update_cache: yes

- name: Verify node
  command: node -v
  register: node_ver
  changed_when: false

- debug:
    var: node_ver.stdout

- name: Verify npm
  command: npm -v
  register: npm_ver
  changed_when: false

- debug:
    var: npm_ver.stdout

- name: Install pnpm globally
  command: npm install -g pnpm
  args:
    creates: /usr/local/bin/pnpm

- name: Verify pnpm version
  command: pnpm -v
  register: pnpm_ver
  changed_when: false

- debug:
    var: pnpm_ver.stdout

- name: Ensure postgres running
  service:
    name: postgresql
    state: started
    enabled: yes

- name: Detect postgres version
  shell: ls /var/lib/postgresql
  register: pg_version
  changed_when: false

- set_fact:
    pg_ver: "{{ pg_version.stdout }}"

#################################################
# MOVE POSTGRES DATA TO TERRAFORM VOLUME
#################################################

- name: Stop postgres before migration
  service:
    name: postgresql
    state: stopped

- name: Ensure persistent postgres directory exists
  file:
    path: /var/lib/umami/postgres
    state: directory
    owner: postgres
    group: postgres
    mode: "0700"

- name: Migrate postgres data if not already migrated
  shell: rsync -a /var/lib/postgresql/{{ pg_ver }}/ /var/lib/umami/postgres/
  args:
    creates: "/var/lib/umami/postgres/main"

- name: Fix postgres ownership
  file:
    path: /var/lib/umami/postgres
    owner: postgres
    group: postgres
    recurse: yes

- name: Update postgres data_directory
  lineinfile:
    path: "/etc/postgresql/{{ pg_ver }}/main/postgresql.conf"
    regexp: "^data_directory"
    line: "data_directory = '/var/lib/umami/postgres/main'"

- name: Start postgres
  service:
    name: postgresql
    state: started
    enabled: yes

- name: Wait for postgres socket
  wait_for:
    path: /var/run/postgresql/.s.PGSQL.5432
    timeout: 60

- name: Create umami database
  become_user: postgres
  postgresql_db:
    name: umami

- name: Create umami DB user
  become_user: postgres
  postgresql_user:
    name: umami
    password: "{{ umami_db_password }}"
    role_attr_flags: LOGIN

- name: Grant DB privileges
  become_user: postgres
  postgresql_privs:
    db: umami
    roles: umami
    type: database
    privs: ALL

- name: Clone Umami repository
  git:
    repo: https://github.com/umami-software/umami.git
    dest: /opt/umami
    version: master
    update: yes

- name: Create Umami env file
  copy:
    dest: /opt/umami/.env
    content: |
      DATABASE_URL=postgresql://umami:{{ umami_db_password }}@localhost:5432/umami
      APP_SECRET={{ umami_app_secret }}
      HOSTNAME=127.0.0.1
      PORT=3000

- name: Install dependencies with pnpm
  command: pnpm install --no-frozen-lockfile
  args:
    chdir: /opt/umami

- name: Generate Prisma client
  command: pnpm prisma generate
  args:
    chdir: /opt/umami

- name: Grant schema usage to umami
  become_user: postgres
  shell: |
    psql -d umami -c "GRANT ALL ON SCHEMA public TO umami;"

- name: Change schema owner to umami
  become_user: postgres
  shell: |
    psql -d umami -c "ALTER SCHEMA public OWNER TO umami;"

- name: Run DB migrations
  command: pnpm prisma migrate deploy
  args:
    chdir: /opt/umami

- name: Build Umami
  command: pnpm build
  args:
    chdir: /opt/umami

- name: Create Umami systemd service
  copy:
    dest: /etc/systemd/system/umami.service
    content: |
      [Unit]
      Description=Umami Analytics
      After=network.target postgresql.service

      [Service]
      Type=simple
      WorkingDirectory=/opt/umami
      ExecStart=/usr/bin/env npm start
      Restart=always
      Environment=NODE_ENV=production

      [Install]
      WantedBy=multi-user.target

- name: Reload systemd
  command: systemctl daemon-reexec

- name: Enable and start Umami
  service:
    name: umami
    enabled: yes
    state: restarted
