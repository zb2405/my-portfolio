---
#################################################
# SYSTEM DEPENDENCIES
#################################################

- name: Install NodeJS 22
  shell: |
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    apt-get install -y nodejs
  args:
    executable: /bin/bash

- name: Install required packages
  apt:
    name:
      - git
      - postgresql
      - postgresql-contrib
      - python3-psycopg2
    state: present
    update_cache: yes

#################################################
# POSTGRESQL SETUP
#################################################

- name: Ensure postgres is running
  service:
    name: postgresql
    state: started
    enabled: yes

- name: Create umami database
  become_user: postgres
  postgresql_db:
    name: umami

- name: Create umami DB user
  become_user: postgres
  postgresql_user:
    name: umami
    password: "{{ umami_db_password }}"
    role_attr_flags: LOGIN

- name: Grant DB privileges
  become_user: postgres
  postgresql_privs:
    db: umami
    roles: umami
    type: database
    privs: ALL

#################################################
# CLONE / UPDATE UMAMI
#################################################

- name: Clone Umami repository
  git:
    repo: https://github.com/umami-software/umami.git
    dest: /opt/umami
    version: master
    update: yes

#################################################
# ENV CONFIGURATION
#################################################

- name: Create Umami .env file
  copy:
    dest: /opt/umami/.env
    content: |
      DATABASE_URL=postgresql://umami:{{ umami_db_password }}@localhost:5432/umami
      APP_SECRET={{ umami_app_secret }}

#################################################
# INSTALL + BUILD
#################################################

- name: Install dependencies
  command: npm ci
  args:
    chdir: /opt/umami

- name: Build Umami
  command: npm run build
  args:
    chdir: /opt/umami

- name: Run database migrations
  command: npm run db:migrate
  args:
    chdir: /opt/umami

#################################################
# SYSTEMD SERVICE
#################################################

- name: Create systemd service
  copy:
    dest: /etc/systemd/system/umami.service
    content: |
      [Unit]
      Description=Umami Analytics
      After=network.target postgresql.service

      [Service]
      Type=simple
      User=root
      WorkingDirectory=/opt/umami
      ExecStart=/usr/bin/env npm start
      Restart=always
      Environment=NODE_ENV=production

      [Install]
      WantedBy=multi-user.target

- name: Reload systemd
  command: systemctl daemon-reexec

- name: Enable and start Umami
  service:
    name: umami
    enabled: yes
    state: restarted
