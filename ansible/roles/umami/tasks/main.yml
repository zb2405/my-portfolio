---
#################################################
# SYSTEM DEPENDENCIES
#################################################

- name: Install base packages
  apt:
    name:
      - curl
      - ca-certificates
      - gnupg
      - git
      - rsync
      - nodejs
      - npm
      - postgresql
      - postgresql-contrib
      - python3-psycopg2
    state: present
    update_cache: yes

#################################################
# VERIFY NODE + NPM
#################################################

- name: Verify node installation
  command: node -v
  register: node_ver
  changed_when: false

- debug:
    var: node_ver.stdout

- name: Verify npm installation
  command: npm -v
  register: npm_ver
  changed_when: false

- debug:
    var: npm_ver.stdout

#################################################
# POSTGRESQL INITIAL SETUP
#################################################

- name: Ensure postgres running
  service:
    name: postgresql
    state: started
    enabled: yes

#################################################
# MOVE POSTGRES DATA TO PERSISTENT VOLUME
#################################################

- name: Stop postgres before migration
  service:
    name: postgresql
    state: stopped

- name: Ensure persistent postgres directory exists
  file:
    path: /var/lib/umami/postgres
    state: directory
    owner: postgres
    group: postgres
    mode: "0700"

- name: Sync postgres data if not migrated
  shell: rsync -a /var/lib/postgresql/ /var/lib/umami/postgres/
  args:
    creates: /var/lib/umami/postgres/base

- name: Update postgres data_directory
  shell: |
    sed -i "s|^data_directory.*|data_directory = '/var/lib/umami/postgres/main'|" \
    /etc/postgresql/*/main/postgresql.conf

- name: Start postgres after migration
  service:
    name: postgresql
    state: started
    enabled: yes

#################################################
# WAIT FOR POSTGRES SOCKET BEFORE PROCEEDING
#################################################

- name: Wait for postgres socket
  wait_for:
    path: /var/run/postgresql/.s.PGSQL.5432
    timeout: 60

#################################################
# DATABASE CONFIG
#################################################

- name: Create umami database
  become_user: postgres
  postgresql_db:
    name: umami

- name: Create DB user
  become_user: postgres
  postgresql_user:
    name: umami
    password: "{{ umami_db_password }}"
    role_attr_flags: LOGIN

- name: Grant privileges
  become_user: postgres
  postgresql_privs:
    db: umami
    roles: umami
    type: database
    privs: ALL

#################################################
# CLONE UMAMI
#################################################

- name: Clone Umami repo
  git:
    repo: https://github.com/umami-software/umami.git
    dest: /opt/umami
    version: master
    update: yes

#################################################
# ENV CONFIGURATION
#################################################

- name: Create Umami env file
  copy:
    dest: /opt/umami/.env
    content: |
      DATABASE_URL=postgresql://umami:{{ umami_db_password }}@localhost:5432/umami
      APP_SECRET={{ umami_app_secret }}
      HOSTNAME=127.0.0.1
      PORT=3000

#################################################
# INSTALL + BUILD
#################################################

- name: Install dependencies
  command: npm ci
  args:
    chdir: /opt/umami

- name: Build Umami
  command: npm run build
  args:
    chdir: /opt/umami

- name: Run DB migrations
  command: npm run db:migrate
  args:
    chdir: /opt/umami

#################################################
# SYSTEMD SERVICE
#################################################

- name: Create Umami service
  copy:
    dest: /etc/systemd/system/umami.service
    content: |
      [Unit]
      Description=Umami Analytics
      After=network.target postgresql.service

      [Service]
      Type=simple
      WorkingDirectory=/opt/umami
      ExecStart=/usr/bin/env npm start
      Restart=always
      Environment=NODE_ENV=production

      [Install]
      WantedBy=multi-user.target

- name: Reload systemd
  command: systemctl daemon-reexec

- name: Enable and start Umami
  service:
    name: umami
    enabled: yes
    state: restarted
